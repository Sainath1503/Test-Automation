stages:
  - build
  - test

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  SELENIUM_HUB_URL: "http://selenium-hub:4444/wd/hub"
  MYSQL_HOST: "mysql"
  MYSQL_DATABASE: "testautomation"
  MYSQL_USER: "root"
  MYSQL_PASSWORD: "root"
  ELASTICSEARCH_ENABLED: "true"
  ELASTICSEARCH_HOST: "elasticsearch"
  ELASTICSEARCH_PORT: "9200"

# Cache Maven dependencies
cache:
  paths:
    - .m2/repository/

# Build stage
build:
  stage: build
  image: maven:3.9.5-eclipse-temurin-17
  script:
    - mvn clean compile -DskipTests
  artifacts:
    paths:
      - target/
    expire_in: 1 hour

# Test stage with Docker Compose
test:
  stage: test
  image: docker/compose:latest
  services:
    - docker:24.0.5-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - docker-compose up -d selenium-hub selenium-node-chrome selenium-node-firefox mysql elasticsearch kibana
    - |
      echo "Waiting for services to be ready..."
      sleep 30
      docker-compose ps
  script:
    - |
      docker run --rm \
        --network container:selenium-hub \
        -v $(pwd):/app \
        -w /app \
        -e SELENIUM_GRID_URL=$SELENIUM_HUB_URL \
        -e SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/$MYSQL_DATABASE \
        -e SPRING_DATASOURCE_USERNAME=$MYSQL_USER \
        -e SPRING_DATASOURCE_PASSWORD=$MYSQL_PASSWORD \
        -e ELASTICSEARCH_ENABLED=$ELASTICSEARCH_ENABLED \
        -e ELASTICSEARCH_HOST=$ELASTICSEARCH_HOST \
        -e ELASTICSEARCH_PORT=$ELASTICSEARCH_PORT \
        maven:3.9.5-eclipse-temurin-17 \
        mvn clean test
  after_script:
    - docker-compose down -v
  artifacts:
    when: always
    paths:
      - target/screenshots/
      - target/reports/
      - target/cucumber-reports/
      - target/api-comparison/
      - target/logs/
    expire_in: 30 days
  coverage: '/Total.*?([0-9]{1,3})%/'

# Alternative: Run tests in Docker Compose environment
test-docker-compose:
  stage: test
  image: docker/compose:latest
  services:
    - docker:24.0.5-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_DRIVER: overlay2
  before_script:
    - apk add --no-cache openjdk17 maven
    - docker-compose up -d
    - sleep 30
  script:
    - |
      docker-compose exec -T mysql mysql -uroot -proot testautomation < src/main/resources/database/init.sql || true
    - mvn clean test -Dselenium.grid.url=http://localhost:4444/wd/hub
  after_script:
    - docker-compose logs selenium-hub
    - docker-compose logs selenium-node-chrome
    - docker-compose down -v
  artifacts:
    when: always
    paths:
      - target/screenshots/
      - target/reports/
      - target/cucumber-reports/
      - target/api-comparison/
      - target/logs/
    expire_in: 30 days
